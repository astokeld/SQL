WITH CIF AS (
    SELECT
        NAME,
        NAME_ID,
        TAX_ID_NUMBER,
        EMPLOYEE_OFFICER_DIRECTOR,
        NAICS_CODE,
        EMAIL_ADDRESS,
        BUSINESS_PHONE
    FROM S_PRD_FISERV_PREMIER.REFINED.CIF_NAME AS CIF
    WHERE DATE_LAST_UPDATED = (SELECT MAX(DATE_LAST_UPDATED) FROM S_PRD_FISERV_PREMIER.REFINED.CIF_NAME)
),
ALL_ACCOUNTS AS (
    SELECT
        NOTE_NUMBER AS ACCOUNT_NUMBER,
        PRIMARY_NAME_ID,
        NOTE.RESP_CODE,
        'NOTE' AS ACCOUNT_TYPE,
        DATE_LAST_UPDATED
    FROM S_PRD_FISERV_PREMIER.REFINED.NOTE_ACCT AS NOTE
    JOIN p_test_commercial_lending.consumption.dim_commercial_roster AS ROSTER
        ON NOTE.RESP_CODE = ROSTER.RESP_CODE
    WHERE DATE_LAST_UPDATED > DATEADD(YEAR, -1, GETDATE()) AND ACTIVE_NOTE = 'Y'
    
    UNION ALL

    SELECT
        DDA_ACCOUNT AS ACCOUNT_NUMBER,
        PRIMARY_NAME_ID,
        DDA.RESP_CODE,
        'DDA' AS ACCOUNT_TYPE,
        DATE_LAST_UPDATED
    FROM S_PRD_FISERV_PREMIER.REFINED.DDA_ACCT AS DDA
    JOIN p_test_commercial_lending.consumption.dim_commercial_roster AS ROSTER
        ON DDA.RESP_CODE = ROSTER.RESP_CODE
    WHERE DATE_LAST_UPDATED > DATEADD(YEAR, -1, GETDATE()) AND STATUS_CODE = '0'
    
    UNION ALL

    SELECT
        SAV_ACCOUNT AS ACCOUNT_NUMBER,
        PRIMARY_NAME_ID,
        SAV.RESP_CODE,
        'SAV' AS ACCOUNT_TYPE,
        DATE_LAST_UPDATED
    FROM S_PRD_FISERV_PREMIER.REFINED.SAV_ACCT AS SAV
    JOIN p_test_commercial_lending.consumption.dim_commercial_roster AS ROSTER
        ON SAV.RESP_CODE = ROSTER.RESP_CODE
    WHERE DATE_LAST_UPDATED > DATEADD(YEAR, -1, GETDATE()) AND STATUS_CODE = '0'
    
    UNION ALL

    SELECT
        COD_ACCOUNT AS ACCOUNT_NUMBER,
        PRIMARY_NAME_ID,
        COD.RESP_CODE,
        'COD' AS ACCOUNT_TYPE,
        DATE_LAST_UPDATED
    FROM S_PRD_FISERV_PREMIER.REFINED.COD_ACCT AS COD
    JOIN p_test_commercial_lending.consumption.dim_commercial_roster AS ROSTER
        ON COD.RESP_CODE = ROSTER.RESP_CODE
    WHERE DATE_LAST_UPDATED > DATEADD(YEAR, -1, GETDATE()) AND STATUS_CODE = '0' AND DATE_CLOSED IS NULL
),
RANKED_ACCOUNTS AS (
    SELECT
        PRIMARY_NAME_ID,
        RESP_CODE,
        DATE_LAST_UPDATED,
        ROW_NUMBER() OVER (PARTITION BY PRIMARY_NAME_ID ORDER BY DATE_LAST_UPDATED DESC) AS RN
    FROM ALL_ACCOUNTS
)
, LATEST_ACCOUNTS AS (
    SELECT PRIMARY_NAME_ID, RESP_CODE
    FROM RANKED_ACCOUNTS
    WHERE RN = 1  -- Only the most recent entry per PRIMARY_NAME_ID
)

SELECT
    CIF.NAME_ID,
    COALESCE(CIF.NAME, 'No Name') AS NAME,
    CIF.TAX_ID_NUMBER,
    CIF.EMPLOYEE_OFFICER_DIRECTOR,
    CIF.NAICS_CODE,
    CIF.EMAIL_ADDRESS,
    CIF.BUSINESS_PHONE,
    LATEST_ACCOUNTS.RESP_CODE
FROM CIF
JOIN LATEST_ACCOUNTS
    ON CIF.NAME_ID = LATEST_ACCOUNTS.PRIMARY_NAME_ID
WHERE CIF.EMPLOYEE_OFFICER_DIRECTOR = '0'
ORDER BY NAME
