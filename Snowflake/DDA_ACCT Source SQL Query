WITH CIF AS(SELECT
NAME,
NAME_ID,
TAX_ID_NUMBER,
EMPLOYEE_OFFICER_DIRECTOR,
NAICS_CODE, 
EMAIL_ADDRESS,
BUSINESS_PHONE
 
FROM S_PRD_FISERV_PREMIER.REFINED.CIF_NAME AS CIF
 
WHERE DATE_LAST_UPDATED = (SELECT MAX(DATE_LAST_UPDATED) FROM S_PRD_FISERV_PREMIER.REFINED.CIF_NAME)),
 
ACCOUNTS AS (SELECT 
    DISTINCT(NOTE_NUMBER) AS ACCOUNT_NUMBER,
    PRIMARY_NAME_ID,
    'NOTE' AS ACCOUNT_TYPE
FROM S_PRD_FISERV_PREMIER.REFINED.NOTE_ACCT AS NOTE
  JOIN p_test_commercial_lending.consumption.dim_commercial_roster AS ROSTER
   ON NOTE.RESP_CODE = ROSTER.RESP_CODE          
WHERE DATE_LAST_UPDATED > DATEADD(YEAR,-1,GETDATE())
  AND ACTIVE_NOTE ='Y'
 
UNION
 
SELECT 
    DISTINCT(DDA_ACCOUNT) AS ACCOUNT_NUMBER,
    PRIMARY_NAME_ID,
    'DDA' AS ACCOUNT_TYPE
FROM S_PRD_FISERV_PREMIER.REFINED.DDA_ACCT AS DDA
  JOIN p_test_commercial_lending.consumption.dim_commercial_roster AS ROSTER
   ON DDA.RESP_CODE = ROSTER.RESP_CODE             
WHERE DATE_LAST_UPDATED > DATEADD(YEAR,-1,GETDATE())
AND STATUS_CODE = '0'
 
UNION
 
SELECT 
     DISTINCT(SAV_ACCOUNT) AS ACCOUNT_NUMBER,
    PRIMARY_NAME_ID,
    'SAV' AS ACCOUNT_TYPE
FROM S_PRD_FISERV_PREMIER.REFINED.SAV_ACCT AS SAV
     JOIN p_test_commercial_lending.consumption.dim_commercial_roster AS ROSTER
   ON SAV.RESP_CODE = ROSTER.RESP_CODE  
             
WHERE DATE_LAST_UPDATED > DATEADD(YEAR,-1,GETDATE())
AND STATUS_CODE = '0'
             
UNION
 
SELECT 
     DISTINCT(COD_ACCOUNT) AS ACCOUNT_NUMBER,
    PRIMARY_NAME_ID,
    'COD' AS ACCOUNT_TYPE
FROM S_PRD_FISERV_PREMIER.REFINED.COD_ACCT AS COD
   JOIN p_test_commercial_lending.consumption.dim_commercial_roster AS ROSTER
   ON COD.RESP_CODE = ROSTER.RESP_CODE  
WHERE DATE_LAST_UPDATED > DATEADD(YEAR,-1,GETDATE())
AND STATUS_CODE = '0'             
AND DATE_CLOSED IS NULL
),
 
A AS (SELECT 
DISTINCT(CIF.NAME_ID)
 
FROM CIF
 
JOIN ACCOUNTS ON CIF.NAME_ID = ACCOUNTS.PRIMARY_NAME_ID
 
WHERE CIF.EMPLOYEE_OFFICER_DIRECTOR = '0')
 
SELECT DDA.*
FROM S_PRD_FISERV_PREMIER.REFINED.DDA_ACCT AS DDA
JOIN A
ON DDA.PRIMARY_NAME_ID = A.NAME_ID
WHERE DATE_LAST_UPDATED > '2023-12-28'
 
AND DDA.STATUS_CODE = '0'
ORDER BY DATE_LAST_UPDATED ASC
